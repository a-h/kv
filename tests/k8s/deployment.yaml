---
apiVersion: v1
kind: Namespace
metadata:
  name: kvtest
  labels:
    name: kvtest

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: kv-storage
  namespace: kvtest
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  # Optional: specify storage class if needed
  # storageClassName: standard

---
apiVersion: batch/v1
kind: Job
metadata:
  name: kv-benchmark-job
  namespace: kvtest
  labels:
    app: kv-benchmark-job
spec:
  template:
    metadata:
      labels:
        app: kv-benchmark-job
    spec:
      containers:
      - name: kv
        image: ghcr.io/a-h/kv:latest
        imagePullPolicy: IfNotPresent
        command: ["/bin/bash"]
        args:
          - "-c"
          - |
            set -e
            echo "Initializing KV store..."
            kv --type=sqlite --connection="file:/data/benchmark.db?mode=rwc" init
            echo "Running mixed benchmark with 10000 operations and 15 workers..."
            kv --type=sqlite --connection="file:/data/benchmark.db?mode=rwc" benchmark mixed 10000 15
            echo "Benchmark completed successfully!"
            echo "Database file size:"
            ls -lah /data/benchmark.db
        volumeMounts:
        - name: kv-storage
          mountPath: /data
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
      volumes:
      - name: kv-storage
        persistentVolumeClaim:
          claimName: kv-storage
      restartPolicy: Never
  backoffLimit: 3
